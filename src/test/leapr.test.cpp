#define CATCH_CONFIG_MAIN
#include "catch.hpp"
#include "leapr.cpp"
#include <unsupported/Eigen/CXX11/Tensor>



void checkSab( const std::vector<double>& correctSab,
  const Eigen::Tensor<double,3>& sab ){

  REQUIRE( sab.dimension(0)*sab.dimension(1)*sab.dimension(2) == correctSab.size() );

  int l = 0;
  for ( int i = 0; i < sab.dimension(0); ++i ){
    for ( int j = 0; j < sab.dimension(1); ++j ){
      for ( int k = 0; k < sab.dimension(2); ++k ){
        REQUIRE( sab(i,j,k) == Approx(correctSab[l]).epsilon(1e-5) );
	l += 1;
      }
    }
  }
}





TEST_CASE( "leapr" ){
  int nout, ntempr, iprint, nphon, mat, npr, iel, ncold, nss, nalpha, nbeta, 
      lat, ni, nd, nka;
  //int mss;
  double sps, b7;
  double za, awr, spr, aws, delta, twt, c, tbeta, dka;
  std::vector<double> alpha, beta, temp, rho, oscE, oscW, 
    kappa;
  std::string title;

  GIVEN( "simple H in H20 input" ) {
    nout   = 24;                                                 // Card 1
    title  = "h in h20, shortened endf model";                   // Card 2
    ntempr = 1;       iprint = 1;      nphon = 100;              // Card 3
    mat    = 101;     za     = 1001.0;                           // Card 4
    awr    = 0.99917; spr    = 20.449; npr   = 2;   iel = 0;   ncold = 0; // Card 5
    nss    = 1;       b7     = 1.;     aws   = 1.1; sps = 3.8883; //mss = 1; 
                                                                     // Card 6
    nalpha = 5;       nbeta  = 7;      lat   = 1;                // Card 7
    alpha  = { 0.01008, 0.015, 0.0252, 0.033, 0.050406 };        // Card 8
    beta   = { 0.00000, 0.006375, 0.012750, 0.025500, 0.038250, 0.05100, 0.065750 }; // Card 9
    temp   = { 296.0 };                                          // Card 10 
    delta  = 0.00255;     ni     = 67;                           // Card 11
    rho    = { 0.00000, 0.00050, 0.00100, 0.00200, 0.00350, 0.00500, 
      0.00750, 0.01000, 0.01300, 0.01650, 0.02000, 0.02450, 0.02900, 
      0.03400, 0.03950, 0.04500, 0.05060, 0.05620, 0.06220, 0.06860, 
      0.07500, 0.08300, 0.09100, 0.09900, 0.10700, 0.11500, 0.11970, 
      0.12140, 0.12180, 0.11950, 0.11250, 0.10650, 0.10050, 0.09542, 
      0.09126, 0.08710, 0.08390, 0.08070, 0.07798, 0.07574, 0.07350, 
      0.07162, 0.06974, 0.06804, 0.06652, 0.06500, 0.06340, 0.06180, 
      0.06022, 0.05866, 0.05710, 0.05586, 0.05462, 0.05350, 0.05250, 
      0.05150, 0.05042, 0.04934, 0.04822, 0.04706, 0.04590, 0.04478, 
      0.04366, 0.04288, 0.04244, 0.04200, 0. };
                                                                     // Card 12
    twt    = 0.055556;     c      = 0.0;    tbeta = 0.444444;    // Card 13
    nd     = 2;                                                  // Card 14
    //oscE  = { 205.0,    0.48};                                  // Card 15
    oscE   = { 35.8,    0.48};                                  // Card 15
    oscW   = { 0.166667, 0.333333 };                             // Card 16
    nka    = 4;       dka    = 0.01;                             // Card 17
    kappa  = { 0.1, 0.2, 0.4, 0.7 };                             // Card 18

    auto out = leapr( nout, title, ntempr, iprint, nphon, mat, za, awr, 
        spr, npr, iel, ncold, nss, aws, nalpha, nbeta, lat, alpha, beta, 
        temp, delta, ni, rho, twt, c, tbeta, nd, oscE, 
        oscW, nka, dka, kappa );

    auto ssm = std::get<2>(out);
 
    std::vector<double> ssmCorrect { 11.9380466,  11.7358569,  11.1552444,  
      9.04435365,  6.36253466,  3.86288069,  1.81640727,  9.77386851,  
      9.67827226,  9.35649187,  8.13748192,  6.42985286,  4.61578595,  
      2.78373847,  7.52086114,  7.48096532,  7.33830900,  6.77191769,  
      5.91039840,  4.85809341,  3.60668537,  6.55904026,  6.53116851,  
      6.44104253,  6.08124304,  5.47109680,  4.72905752,  3.76787280,
      5.28338485,  5.26835188,  5.23245837,  5.03910024,  4.71891225,  
      4.29716228,  3.7169103340 };



    checkSab( ssmCorrect, ssm );


  /*

  */
  } // GIVEN 


  GIVEN( "H in H2O input (TEST 09)" ) {

  nout   = 20;                                                      // Card 1
  title  = "H IN H2O, ENDF MODEL";                                  // Card 2
  ntempr = 1;       iprint = 1;     nphon = 100;                    // Card 3
  mat    = 1;       za     = 1001.0;                                // Card 4
  awr    = 0.99917; spr    = 20.478;  npr   = 2;  iel = 0;   ncold = 0;
  nss    = 1;       b7     = 1.0;   aws = 15.85316;   sps = 3.8883; // Card 6
  nalpha = 65;      nbeta  = 75;    lat   = 1;                      // Card 7
  std::vector<double> alpha = { 0.01008, 0.015, 0.0252, 0.033, 0.050406, 0.0756, 0.100812, 
    0.151218, 0.201624, 0.252030, 0.302436, 0.352842, 0.403248, 0.453654, 
    0.504060, 0.554466, 0.609711, 0.670259, 0.736623, 0.809349, 0.889061, 
    0.976435, 1.072130, 1.177080, 1.292110, 1.418220, 1.556330, 1.707750, 
    1.873790, 2.055660, 2.255060, 2.473520, 2.712950, 2.975460, 3.263080, 
    3.578320, 3.923900, 4.302660, 4.717700, 5.172560, 5.671180, 6.217580, 
    6.816500, 7.472890, 8.192280, 8.980730, 9.844890, 10.79190, 11.83030, 
    12.96740, 14.21450, 15.58150, 17.07960, 18.72080, 20.52030, 22.49220, 
    24.65260, 27.02160, 29.61750, 32.46250, 35.58160, 38.99910, 42.74530, 
    46.85030, 50.0 };  // Card 8
  std::vector<double> beta = { 0.000000, 0.006375, 0.012750, 0.025500, 0.038250, 0.051000, 0.065750, 
    0.0806495, 0.120974, 0.161299, 0.241949, 0.322598, 0.403248, 0.483897, 
    0.564547, 0.645197, 0.725846, 0.806496, 0.887145, 0.967795, 1.048440, 
    1.129090, 1.209740, 1.290390, 1.371040, 1.451690, 1.532340, 1.612990, 
    1.693640, 1.774290, 1.854940, 1.935590, 2.016240, 2.096890, 2.177540, 
    2.258190, 2.338840, 2.419490, 2.500140, 2.580790, 2.669500, 2.767090, 
    2.874450, 2.992500, 3.122350, 3.265300, 3.422470, 3.595360, 3.785490, 
    3.994670, 4.224730, 4.477870, 4.756310, 5.062580, 5.399390, 5.769970, 
    6.177660, 6.626070, 7.119240, 7.661810, 8.258620, 8.915110, 9.637220, 
    10.43200, 11.30510, 12.26680, 13.32430, 14.48670, 15.00000 }; // Card 9
  temp   = { 296.0 };                                             // Card 10 
  delta  = 0.00255;    ni = 67;                                   // Card 11
  std::vector<double> rho = { 0.0, 0.0005, 0.001, 0.002, 0.0035, 0.005, 0.0075, 0.01, 
    0.013, 0.0165, 0.02, 0.0245, 0.029, 0.034, 0.0395, 0.045, 0.0506, 0.0562, 
    0.0622, 0.0686, 0.075, 0.083, 0.091, 0.099, 0.107, 0.115, 0.1197, 0.1214, 
    0.1218, 0.1195, 0.1125, 0.1065, 0.1005, 0.09542, 0.09126, 0.0871, 0.0839, 
    0.0807, 0.07798, 0.07574, 0.0735, 0.07162, 0.06974, 0.06804, 0.06652, 0.065, 
    0.0634, 0.0618, 0.06022, 0.05866, 0.0571, 0.05586, 0.05462, 0.0535, 0.0525, 
    0.0515, 0.05042, 0.04934, 0.04822, 0.04706, 0.0459, 0.04478, 0.04366, 
    0.04288, 0.04244, 0.042, 0.0 };           // Card 12
  twt = 0.055556; c = 0.0; tbeta = 0.444444;  // Card 13
  nd = 2;                                     // Card 14
  oscE = { 0.205, 0.48 };                     // Card 15
  oscW = { 0.166667, 0.333333 };              // Card 16
  nka = 0; dka = 0.0;                         // Card 17
  kappa    = { };                             // Card 18

  auto out = leapr( nout, title, ntempr, iprint, nphon, mat, za, awr, 
      spr, npr, iel, ncold, nss, aws, nalpha, nbeta, lat, alpha, beta, 
      temp, delta, ni, rho, twt, c, tbeta, nd, oscE, 
      oscW, nka, dka, kappa );

  double lambda_s = std::get<0>(out);
  double t_eff = std::get<1>(out);
  auto ssm = std::get<2>(out);
  std::vector<double> ssmCorrect { 0.119356142e2, 0.117334667e2, 
    0.111529773e2,  0.904255723e1,  0.636134291e1,  0.386225471e1, 
    0.181630359e1,  0.697623746,    0.199068662e-1, 0.569440243e-3, 
    0.323354841e-3, 0.298221350e-3, 0.299636508e-3, 0.296107320e-3, 
    0.305358546e-3, 0.317758356e-3, 0.326530893e-3, 0.336691180e-3, 
    0.348223478e-3, 0.357718815e-3, 0.369090083e-3, 0.382591059e-3, 
    0.394398171e-3, 0.406759025e-3, 0.419774567e-3, 0.431823920e-3, 
    0.442245818e-3, 0.451355517e-3, 0.459290279e-3, 0.467651065e-3, 
    0.476698427e-3, 0.485834717e-3, 0.495460725e-3, 0.509308056e-3, 
    0.523250483e-3, 0.536046544e-3, 0.547826154e-3, 0.558668540e-3, 
    0.567071035e-3, 0.567084677e-3, 0.557415136e-3, 0.538837584e-3, 
    0.509977877e-3, 0.464215388e-3, 0.411625532e-3, 0.361822880e-3, 
    0.318357294e-3, 0.280133529e-3, 0.246821936e-3, 0.218470623e-3, 
    0.193489674e-3, 0.171402084e-3, 0.150253931e-3, 0.130243202e-3, 
    0.113510906e-3, 0.982754621e-4, 0.802454259e-4, 0.182914420e-4, 
    0.249039250e-6, 0.193616416e-6, 0.306535223e-6, 0.147774909e-6, 
    0.134201772e-6, 0.134933726e-6, 0.894699751e-7, 0.447002647e-7, 
    0.254040302e-7, 0.878879377e-8, 0.284829773e-8, 0.140098636e-7, 
    0.442991464e-7, 0.764914462e-7, 0.610267227e-7, 0.202222965e-7, 
    0.344001368e-10, 0.232418891e-10, 0.547995627e-11, 0.568984337e-14, 
    0.436851316e-15, 0.245368997e-18, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
    0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.977095038e1, 0.967539510e1, 
    0.935371327e1, 0.813515003e1, 0.642810949e1, 0.461467841e1 };

  std::vector<double> ssm_alpha_0_49_beta_0_49 { 11.935614, 9.6753951, 7.3348118, 6.0777375, 
    4.7152145, 3.7635737, 3.1352778, 2.5435978, 1.9451342, 1.5299730, 0.9617595, 
    0.5859237, 0.3524469, 0.2124005, 0.1300019, 8.2531345e-2, 5.6886704e-2, 
    4.3458881e-2, 3.6822232e-2, 3.4067983e-2, 3.3632585e-2, 3.4628352e-2, 
    3.6546693e-2, 3.9131910e-2, 4.2191691e-2, 4.5634099e-2, 4.9388018e-2, 
    5.3368441e-2, 5.7527799e-2, 6.1792375e-2, 6.6065929e-2, 7.0233475e-2, 
    7.4218351e-2, 7.7872169e-2, 8.1100605e-2, 8.3812876e-2, 8.5914606e-2, 
    8.7365248e-2, 8.8101263e-2, 8.8115627e-2, 8.7348737e-2, 8.5804720e-2, 
    8.3492917e-2, 8.0470802e-2, 7.6789248e-2, 7.2560911e-2, 6.7879552e-2, 
    6.2878926e-2, 5.7644932e-2, 5.2325611e-2, 4.6996838e-2, 4.1750932e-2, 
    3.6686082e-2, 3.1863917e-2, 2.7336267e-2, 2.3145924e-2, 1.9324611e-2, 
    1.5889523e-2, 1.2853166e-2, 1.0214210e-2, 7.9612973e-3, 6.0777445e-3, 
    4.5355538e-3, 3.3038095e-3, 2.7361841e-3 };
  std::vector<double> ssm_alpha_29_beta_0_39 { 0.5075435, 0.5087149, 0.5099015, 
    0.5120805, 0.5143626, 0.5168548, 0.5195800, 0.5205411, 0.5222588, 0.5201505, 
    0.5066769, 0.4814219, 0.4461412, 0.4027074, 0.3550043, 0.3064586, 0.2598735, 
    0.2170864, 0.1793159, 0.1473404, 0.1215918, 0.1017288, 8.700412e-2, 
    7.656394e-2, 6.950085e-2, 6.510340e-2, 6.265127e-2, 6.156786e-2, 6.138864e-2, 
    6.179237e-2, 6.254617e-2, 6.347645e-2, 6.448598e-2, 6.546971e-2, 6.638564e-2, 
    6.717356e-2, 6.778630e-2, 6.821271e-2, 6.839302e-2, 6.832765e-2 };
  std::vector<double> ssm_alpha_0_39_beta_40 { 5.57415136e-4, 8.28335298e-4, 
    1.38765192e-3, 1.81319262e-3, 2.75597276e-3, 4.10379550e-3, 5.43260358e-3, 
    8.03115066e-3, 1.05535283e-2, 1.30041386e-2, 1.53847306e-2, 1.77000686e-2, 
    1.99510266e-2, 2.21390179e-2, 2.42686023e-2, 2.63383940e-2, 2.85428116e-2, 
    3.08854175e-2, 3.33695419e-2, 3.59893717e-2, 3.87456221e-2, 4.16348357e-2, 
    4.46483735e-2, 4.77815183e-2, 5.10161200e-2, 5.43383922e-2, 5.77140508e-2, 
    6.11324854e-2, 6.45536433e-2, 6.79373750e-2, 7.12310538e-2, 7.43908691e-2, 
    7.73717267e-2, 8.01064016e-2, 8.25233157e-2, 8.45724972e-2, 8.61959064e-2, 
    8.73502727e-2, 8.79674594e-2, 8.79771268e-2 };
   
  for ( size_t i = 0; i < ssm_alpha_0_49_beta_0_49.size(); ++i ){ 
    REQUIRE( ssm_alpha_0_49_beta_0_49[i] == Approx(ssm(i,i,0)).epsilon(5e-5) ); 
  }
  for ( size_t i = 0; i < ssm_alpha_29_beta_0_39.size(); ++i ){ 
    REQUIRE( ssm_alpha_29_beta_0_39[i] == Approx(ssm(29,i,0)).epsilon(1e-6) ); 
  }
  for ( size_t i = 0; i < ssm_alpha_0_39_beta_40.size(); ++i ){ 
    REQUIRE( ssm_alpha_0_39_beta_40[i] == Approx(ssm(i,40,0)).epsilon(1e-6) ); 
  }
  //checkSab( ssmCorrect, ssm );
  REQUIRE( 0.23520650 == Approx(lambda_s).epsilon(1e-6) );        
  REQUIRE( 1.93448465 == Approx(t_eff).epsilon(1e-6) );        

  b7  += 1.0;
  sps += 1.0;

 
  } // GIVEN 


  GIVEN( "Para hydrogen at 20K (TEST 22)" ) {

  nout   = 20;                                                    // Card 1
  title  = "para hydrogen at 20k";                                // Card 2
  ntempr = 1;       iprint = 2;     nphon = 100;                  // Card 3
  mat    = 2;       za     = 1001.0;  
  // int isabt = 0; int ilog = 0; 
  double smin = 2.0e-38;                                           // Card 4
  awr    = 0.99917; spr   = 20.478; npr = 2;   iel = 0; ncold = 2; // Card 5
  nss    = 0;       b7    = 0.0;    aws = 0.0; sps = 0.0;          // Card 6
  nalpha = 59;      nbeta = 105;    lat = 0;                       // Card 7
  std::vector<double> alpha = { 0.001, 0.002, 0.005, 0.01, 0.02, 0.05, 
    0.1, 0.15, 0.2, 0.3, 0.5, 0.7, 1, 1.5, 2, 3, 4, 5, 6, 7, 8, 10, 12, 
    14, 16, 18, 20, 25, 30, 40, 50, 60, 80, 100, 120, 140, 160, 180, 200,
    220, 240, 260, 280, 300, 320, 340, 360, 380, 400, 420, 440, 460, 480, 
    500, 520, 540, 560, 580, 600 };                                // Card 8
  std::vector<double> beta = { 0, 0.01, 0.05, 0.1, 0.15, 0.2, 0.3, 
    0.4, 0.5, 0.7, 1, 1.5, 2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 5.7, 
    5.8, 5.9, 6, 6.25, 6.5, 7, 7.5, 8, 8.4, 8.5, 8.6, 8.7027, 8.8, 
    8.9, 9, 9.5, 10, 10.5, 11, 11.5, 12, 12.5, 13, 13.5, 14, 14.5, 
    15, 15.5, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 25.7, 26.1, 
    26.5, 27, 28, 29, 30, 35, 37.5, 40, 45.5, 50, 52.2, 55, 60, 65, 
    70, 75, 80, 85, 90, 95, 100, 105, 110, 115, 120, 125, 130, 135, 
    140, 145, 150, 160, 170, 180, 190, 200, 210, 220, 230, 240, 250, 
    260, 280, 300 }; // Card 9
  temp   = { 20.0 };                                             // Card 10 
  delta  = 0.00025;    ni = 48;                                  // Card 11
  std::vector<double> rho = { 0.0, 0.01563, 0.0625, 0.141, 0.25, 
    0.391, 0.5625, 0.766, 1., 1.266, 1.5625, 1.89, 2.25, 2.64, 3.0625, 
    3.52, 4., 4.6, 5.5, 7.0, 8.5, 9.2, 9.5, 9.4, 9.2, 8.9, 8.5, 8.0, 
    7.5, 7.05, 6.7, 6.4, 6.2, 6.1, 6.2, 6.45, 6.7, 6.95, 7.1, 6.55, 5.5, 
    3.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0 };      // Card 12
  twt = 0.025; c = 40.0; tbeta = 0.475;       // Card 13
  nd = 0;                                     // Card 14
  oscE = { };                                 // Card 15
  oscW = { };                                 // Card 16
  nka = 301; dka = 0.05;                      // Card 17
  kappa = { 9.29815e-2, 9.29815e-2, 9.31478e-2, 9.43837e-2, 9.5458e-2, 
    9.68871e-2, 9.86644e-2, 1.00813e-1, 1.03358e-1, 1.06334e-1, 1.09777e-1, 
    1.1373e-1, 1.18249e-1, 1.23395e-1, 1.29241e-1, 1.35875e-1, 1.43399e-1, 
    1.51932e-1, 1.61618e-1, 1.72622e-1, 1.85143e-1, 1.99416e-1, 2.15717e-1, 
    2.34376e-1, 2.55779e-1, 2.80385e-1, 3.08731e-1, 3.41443e-1, 3.7924e-1, 
    4.22934e-1, 4.73417e-1, 5.3162e-1, 5.98441e-1, 6.74614e-1, 7.9867e-1, 
    1.118, 1.4087, 1.6633, 1.8799, 2.0554, 2.1889, 2.2803, 2.3306, 2.3418, 
    2.3164, 2.2581, 2.1706, 2.0585, 1.9264, 1.779, 1.6213, 1.4581, 1.2938, 
    1.1327, 9.7879e-1, 8.3545e-1, 7.0565e-1, 5.918e-1, 4.9576e-1, 4.1882e-1, 
    3.6172e-1, 3.2464e-1, 3.0727e-1, 3.0884e-1, 3.2812e-1, 3.6355e-1, 
    4.1325e-1, 4.751e-1, 5.4681e-1, 6.2601e-1, 7.1023e-1, 7.9708e-1, 8.8421e-1, 
    9.6942e-1, 1.0507, 1.1261, 1.1943, 1.2538, 1.3037, 1.3432, 1.3719, 1.3897, 
    1.3968, 1.3935, 1.3805, 1.3586, 1.3289, 1.2924, 1.2505, 1.2045, 1.1557, 
    1.1055, 1.0551, 1.0059, 9.5899e-1, 9.1541e-1, 8.7608e-1, 8.4174e-1, 8.1298e-1, 
    7.9025e-1, 7.738e-1, 7.6372e-1, 7.5995e-1, 7.6226e-1, 7.7032e-1, 7.8364e-1, 
    8.0164e-1, 8.2367e-1, 8.4898e-1, 8.7681e-1, 9.0637e-1, 9.3684e-1, 9.6745e-1, 
    9.9744e-1, 1.0261, 1.0529, 1.0771, 1.0984, 1.1163, 1.1306, 1.141, 1.1476, 
    1.1504, 1.1493, 1.1447, 1.1369, 1.126, 1.1126, 1.0971, 1.0799, 1.0616, 
    1.0426, 1.0233, 1.0044, 9.8614e-1, 9.6901e-1, 9.5336e-1, 9.3949e-1, 9.2766e-1, 
    9.1806e-1, 9.1082e-1, 9.0602e-1, 9.0365e-1, 9.0367e-1, 9.0598e-1, 9.1043e-1, 
    9.1682e-1, 9.2491e-1, 9.3444e-1, 9.4513e-1, 9.5667e-1, 9.6876e-1, 9.8109e-1, 
    9.9335e-1, 1.0053, 1.0166, 1.027, 1.0364, 1.0445, 1.0513, 1.0566, 1.0603, 
    1.0625, 1.0631, 1.0622, 1.0599, 1.0563, 1.0515, 1.0457, 1.0391, 1.0318, 1.0241, 
    1.0161, 1.008, 1.0001, 9.925e-1, 9.8538e-1, 9.7887e-1, 9.7311e-1, 9.682e-1, 
    9.6422e-1, 9.6122e-1, 9.5924e-1, 9.5828e-1, 9.5832e-1, 9.5932e-1, 9.6122e-1, 
    9.6394e-1, 9.6739e-1, 9.7145e-1, 9.7602e-1, 9.8096e-1, 9.8614e-1, 9.9145e-1, 
    9.9674e-1, 1.0019, 1.0068, 1.0114, 1.0155, 1.0192, 1.0222, 1.0246, 1.0264, 
    1.0275, 1.0279, 1.0277, 1.0268, 1.0254, 1.0234, 1.021, 1.0182, 1.0151, 1.0117, 
    1.0082, 1.0047, 1.0012, 9.9774e-1, 9.945e-1, 9.9151e-1, 9.8882e-1, 9.8648e-1, 
    9.8454e-1, 9.8302e-1, 9.8193e-1, 9.813e-1, 9.8111e-1, 9.8135e-1, 9.820e-1, 
    9.8303e-1, 9.8441e-1, 9.8608e-1, 9.8801e-1, 9.9013e-1, 9.924e-1, 9.9475e-1, 
    9.9713e-1, 9.9949e-1, 1.0018, 1.0039, 1.0059, 1.0077, 1.0092, 1.0105, 1.0115, 
    1.0122, 1.0126, 1.0127, 1.0125, 1.012, 1.0113, 1.0104, 1.0092, 1.0079, 1.0065, 
    1.0049, 1.0034, 1.0017, 1.0001, 9.986e-1, 9.9715e-1, 9.958e-1, 9.946e-1, 
    9.9355e-1, 9.9269e-1, 9.9201e-1, 9.9154e-1, 9.9126e-1, 9.9119e-1, 9.9132e-1, 
    9.9163e-1, 9.9211e-1, 9.9274e-1, 9.9351e-1, 9.944e-1, 9.9537e-1, 9.9641e-1, 
    9.9749e-1, 9.9859e-1, 9.9967e-1, 1.0007, 1.0017, 1.0026, 1.0035, 1.0042, 
    1.0048, 1.0053, 1.0056, 1.0058, 1.0058, 1.0058, 1.0056, 1.0053, 1.0048, 1.0043, 
    1.0037, 1.0031, 1.0024, 1.0016, 1.0009, 1.0001, 9.994e-1 };                             // Card 18

  auto out = leapr( nout, title, ntempr, iprint, nphon, mat, za, awr, 
      spr, npr, iel, ncold, nss, aws, nalpha, nbeta, lat, alpha, beta, 
      temp, delta, ni, rho, twt, c, tbeta, nd, oscE, 
      oscW, nka, dka, kappa );

  double lambda_s = std::get<0>(out);
  double t_eff = std::get<1>(out);
  auto ssm = std::get<2>(out);
  REQUIRE( 0.18256462793803138 == Approx(lambda_s).epsilon(1e-6) );        
 
  } // GIVEN 



  /*

  GIVEN( "graphite input" ){
    WHEN( "1 temperature is requested" ){


    nout         = 20;                                               // Card 1
    title        = "GRAPHITE, ENDF MODEL (EXTENDED) ";               // Card 2
    ntempr       = 1;        iprint = 1;      nphon = 100;           // Card 3
    mat          = 31;       za     = 131.0;                         // Card 4
    awr          = 11.898;   spr    = 4.7392; npr   = 1;   iel = 1;   ncold = 0;
                                                                     // Card 5
    nss          = 0;       b7     = 0;     aws   = 0; sps = 0; mss = 0; 
                                                                     // Card 6
    nalpha       = 72;       nbeta  = 96;      lat   = 1;              // Card 7
    alpha = { 0.010080,  0.01500 ,  0.0252000,  0.03300,   0.050400,   
              0.075600,  0.100800,  0.150000,   2.5203E-1, 0.33000,  
              5.0406e-1, 7.5609e-1, 1.008120,   1.260150,  1.512180,   
              1.76421,   2.016240,  2.273310,   2.535520,  2.802970,  
              3.075770,  3.35401,   3.637900,   3.927330,  4.222710,  
              4.523830,  4.831110,  5.14443,    5.464110,  5.790130, 
              6.122610,  6.461850,  6.807830,   7.16077,   7.520670,   
              7.887830,  8.262340,  8.644320,   9.033960,  9.43136,   
              9.836730,  1.02506e1, 1.06719e1,  1.11024e1, 1.154090e1, 
              1.19886E1, 1.24452e1, 1.291100e1, 1.338580e1, 14, 15, 16, 
              17, 18, 19, 20, 22, 24, 26, 28, 30, 32.5, 35, 37.5, 40, 
              42.5, 45, 47.5, 50, 52.5, 55, 60 }; // Card, 8
 beta = { 0.000000, 0.100812, 0.201624, 0.302436, 
          0.403248, 0.504060, 0.604872, 0.705684, 0.806496, 
          0.907307, 1.00812, 1.108930, 1.209740, 1.310550, 1.411370, 
          1.51218, 1.612990, 1.713800, 1.814610, 1.915430, 2.016240, 
          2.11705, 2.217860, 2.318670, 2.419490, 2.520300, 2.621110, 
          2.72192, 2.822730, 2.923540, 3.024360, 3.125170, 3.225980,
          3.32679, 3.427600, 3.528420, 3.629230, 3.730040, 3.830850, 
          3.93167, 4.032480, 4.133290, 4.243780, 4.364850, 4.497620, 
          4.64309, 4.802480, 4.977190, 5.168730, 5.378620, 5.608670, 
          5.73473, 5.860800, 5.998960, 6.137130, 6.288550, 6.439970, 
          6.60591, 6.771840, 6.953760, 7.135670, 7.335020, 7.534380, 
          7.75289, 7.971400, 8.210880, 8.450360, 8.975290, 9.550520, 
          10.1810, 10.8726, 11.6297, 12.4593, 13.3697, 14.3667, 15.4595, 
          16.6571, 17.9697, 19.4093, 20.9860, 22.7139, 24.6082, 26.6849, 
          28.9602, 31.4533, 34.1873, 37.1825, 40.4659, 45, 50, 55, 60, 65, 70, 
          75, 80  }; // Card 9
    temp     = { 296.0 }; // Card 10 
    delta        = 0.005485;     ni     = 40;                         // Card 11
    rho          = { 0, 0.346613, 1.4135, 3.03321, 3.25901, 3.38468, 3.48269,
                     3.76397, 4.05025, 4.84696, 7.35744, 5.88224, 4.63255,
                     4.48287, 5.80642, 4.63802, 4.28503, 3.92079, 4.91352,
                     5.53836, 7.51076, 5.31651, 5.40525, 5.20376, 5.3276,
                     7.17251, 3.31813, 4.50126, 5.04663, 4.2089, 2.91985,
                     4.65109, 13.1324, 7.25016, 6.5662, 5.47181, 5.06137,
                     5.19813, 0.457086, 0 };
                                                                     // Card 12
    twt = 0.0;     c      = 0.0;    tbeta = 1.0;  // Card 13
    nd           = 2;                                                // Card 14
    //oscE  = { 205.0,    0.48};                              // Card 15
    oscE  = { };                                 // Card 15
    oscW   = {  };                           // Card 16
    nka          = 0;       dka    = 0.01;                           // Card 17
    kappa    = { 0 };                           // Card 18


    std::vector<double> ssmCorrect { 0.189753E-2, 0.199576E-2, 0.209399E-2, 
      0.221587E-2, 0.234194E-2, 0.241997E-2, 0.247731E-2, 0.228906E-2, 
      0.189860E-2, 0.157984E-2, 0.136957E-2, 0.118065E-2, 0.105668E-2, 
      0.938891E-3, 0.878816E-3, 0.818746E-3, 0.776936E-3, 0.736161E-3, 
      0.733310E-3, 0.740193E-3, 0.814278E-3, 0.925300E-3, 0.915797E-3, 
      0.783211E-3, 0.663791E-3, 0.569485E-3, 0.488100E-3, 0.460499E-3, 
      0.435712E-3, 0.473315E-3, 0.510921E-3, 0.459161E-3, 0.396657E-3, 
      0.362124E-3, 0.337310E-3, 0.314245E-3, 0.292393E-3, 0.290292E-3, 
      0.313220E-3, 0.332288E-3, 0.341925E-3, 0.356657E-3, 0.407082E-3, 
      0.429622E-3, 0.339828E-3, 0.298556E-3, 0.289412E-3, 0.270417E-3, 
      0.264804E-3, 0.325671E-3, 0.176347E-3, 0.172707E-3, 0.198404E-3, 
      0.208465E-3, 0.200897E-3, 0.171850E-3, 0.132499E-3, 0.145010E-3, 
      0.249993E-3, 0.467271E-3, 0.278984E-3, 0.233567E-3, 0.195733E-3, 
      0.170835E-3, 0.166179E-3, 0.341319E-4, 0.106011E-5, 0.525807E-6, 
      0.383740E-6, 0.286798E-6, 0.196718E-6, 0.151687E-6, 0.110447E-6, 
      0.655476E-7, 0.476442E-7, 0.141098E-7, 0.121551E-9, 0.560642E-10, 
      0.266458E-10, 0.100644E-10, 0.216661E-11, 0.140957E-13, 0.375906E-14, 
      0.680983E-15, 0.114053E-16, 0.342559E-18, 0.210903E-19, 0.645103E-22, 
      0.735154E-24, 0.664497E-27, 0.000000E+00, 0.000000E+00, 0.000000E+00, 
      0.000000E+00, 0.000000E+00, 0.000000E+00, 0.281685E-2, 0.296264E-2, 
      0.310842E-2, 0.328926E-2 };
 
  auto ssm = leapr( nout, title, ntempr, iprint, nphon, mat, za, awr, 
      spr, npr, iel, ncold, nss, aws, nalpha, nbeta, lat, alpha, beta, 
      temp, delta, ni, rho, twt, c, tbeta, nd, oscE, 
      oscW, nka, dka, kappa );
  checkSab( ssmCorrect, ssm );

    } // WHEN

    WHEN( "multiple temperatures are requested" ){


    nout         = 20;                                               // Card 1
    title        = "GRAPHITE, ENDF MODEL (EXTENDED) ";               // Card 2
    ntempr       = 10;       iprint = 1;      nphon = 100;           // Card 3
    mat          = 31;       za     = 131.0;                         // Card 4
    awr          = 11.898;   spr    = 4.7392; npr   = 1;   iel = 1;   ncold = 0;
                                                                     // Card 5
    nss          = 0;       b7     = 0;     aws   = 0; sps = 0; mss = 0; 
                                                                     // Card 6
    nalpha       = 72;       nbeta  = 96;      lat   = 1;              // Card 7
    alpha = { 0.010080,  0.01500 ,  0.0252000,  0.03300,   0.050400,   
              0.075600,  0.100800,  0.150000,   2.5203E-1, 0.33000,  
              5.0406e-1, 7.5609e-1, 1.008120,   1.260150,  1.512180,   
              1.76421,   2.016240,  2.273310,   2.535520,  2.802970,  
              3.075770,  3.35401,   3.637900,   3.927330,  4.222710,  
              4.523830,  4.831110,  5.14443,    5.464110,  5.790130, 
              6.122610,  6.461850,  6.807830,   7.16077,   7.520670,   
              7.887830,  8.262340,  8.644320,   9.033960,  9.43136,   
              9.836730,  1.02506e1, 1.06719e1,  1.11024e1, 1.154090e1, 
              1.19886E1, 1.24452e1, 1.291100e1, 1.338580e1, 14, 15, 16, 
              17, 18, 19, 20, 22, 24, 26, 28, 30, 32.5, 35, 37.5, 40, 
              42.5, 45, 47.5, 50, 52.5, 55, 60 }; // Card, 8
 beta = { 0.000000, 0.100812, 0.201624, 0.302436, 
          0.403248, 0.504060, 0.604872, 0.705684, 0.806496, 
          0.907307, 1.00812, 1.108930, 1.209740, 1.310550, 1.411370, 
          1.51218, 1.612990, 1.713800, 1.814610, 1.915430, 2.016240, 
          2.11705, 2.217860, 2.318670, 2.419490, 2.520300, 2.621110, 
          2.72192, 2.822730, 2.923540, 3.024360, 3.125170, 3.225980,
          3.32679, 3.427600, 3.528420, 3.629230, 3.730040, 3.830850, 
          3.93167, 4.032480, 4.133290, 4.243780, 4.364850, 4.497620, 
          4.64309, 4.802480, 4.977190, 5.168730, 5.378620, 5.608670, 
          5.73473, 5.860800, 5.998960, 6.137130, 6.288550, 6.439970, 
          6.60591, 6.771840, 6.953760, 7.135670, 7.335020, 7.534380, 
          7.75289, 7.971400, 8.210880, 8.450360, 8.975290, 9.550520, 
          10.1810, 10.8726, 11.6297, 12.4593, 13.3697, 14.3667, 15.4595, 
          16.6571, 17.9697, 19.4093, 20.9860, 22.7139, 24.6082, 26.6849, 
          28.9602, 31.4533, 34.1873, 37.1825, 40.4659, 45, 50, 55, 60, 65, 70, 
          75, 80  }; // Card 9
    temp     = { 296.0, 400, 500, 600, 700, 800, 1200, 1600, 2000 }; // Card 10 
    delta        = 0.005485;     ni     = 40;                         // Card 11
    rho          = { 0, 0.346613, 1.4135, 3.03321, 3.25901, 3.38468, 3.48269,
                     3.76397, 4.05025, 4.84696, 7.35744, 5.88224, 4.63255,
                     4.48287, 5.80642, 4.63802, 4.28503, 3.92079, 4.91352,
                     5.53836, 7.51076, 5.31651, 5.40525, 5.20376, 5.3276,
                     7.17251, 3.31813, 4.50126, 5.04663, 4.2089, 2.91985,
                     4.65109, 13.1324, 7.25016, 6.5662, 5.47181, 5.06137,
                     5.19813, 0.457086, 0 };
                                                                     // Card 12
    twt = 0.0;     c      = 0.0;    tbeta = 1.0;  // Card 13
    nd           = 2;                                                // Card 14
    //oscE  = { 205.0,    0.48};                              // Card 15
    oscE  = { };                                 // Card 15
    oscW   = {  };                           // Card 16
    nka          = 0;       dka    = 0.01;                           // Card 17
    kappa    = { 0 };                           // Card 18




    std::vector<double> ssmCorrect { 0.189753E-2, 0.199576E-2, 0.209399E-2, 
      0.221587E-2, 0.234194E-2, 0.241997E-2, 0.247731E-2, 0.228906E-2, 
      0.189860E-2, 0.157984E-2, 0.136957E-2, 0.118065E-2, 0.105668E-2, 
      0.938891E-3, 0.878816E-3, 0.818746E-3, 0.776936E-3, 0.736161E-3, 
      0.733310E-3, 0.740193E-3, 0.814278E-3, 0.925300E-3, 0.915797E-3, 
      0.783211E-3, 0.663791E-3, 0.569485E-3, 0.488100E-3, 0.460499E-3, 
      0.435712E-3, 0.473315E-3, 0.510921E-3, 0.459161E-3, 0.396657E-3, 
      0.362124E-3, 0.337310E-3, 0.314245E-3, 0.292393E-3, 0.290292E-3, 
      0.313220E-3, 0.332288E-3, 0.341925E-3, 0.356657E-3, 0.407082E-3, 
      0.429622E-3, 0.339828E-3, 0.298556E-3, 0.289412E-3, 0.270417E-3, 
      0.264804E-3, 0.325671E-3, 0.176347E-3, 0.172707E-3, 0.198404E-3, 
      0.208465E-3, 0.200897E-3, 0.171850E-3, 0.132499E-3, 0.145010E-3, 
      0.249993E-3, 0.467271E-3, 0.278984E-3, 0.233567E-3, 0.195733E-3, 
      0.170835E-3, 0.166179E-3, 0.341319E-4, 0.106011E-5, 0.525807E-6, 
      0.383740E-6, 0.286798E-6, 0.196718E-6, 0.151687E-6, 0.110447E-6, 
      0.655476E-7, 0.476442E-7, 0.141098E-7, 0.121551E-9, 0.560642E-10, 
      0.266458E-10, 0.100644E-10, 0.216661E-11, 0.140957E-13, 0.375906E-14, 
      0.680983E-15, 0.114053E-16, 0.342559E-18, 0.210903E-19, 0.645103E-22, 
      0.735154E-24, 0.664497E-27, 0.000000E+00, 0.000000E+00, 0.000000E+00, 
      0.000000E+00, 0.000000E+00, 0.000000E+00, 0.281685E-2, 0.296264E-2, 
      0.310842E-2, 0.328926E-2 };
 
//  auto ssm = leapr( nout, title, ntempr, iprint, nphon, mat, za, awr, 
//      spr, npr, iel, ncold, nss, aws, nalpha, nbeta, lat, alpha, beta, 
//      temp, delta, ni, rho, twt, c, tbeta, nd, oscE, 
//      oscW, nka, dka, kappa );
//  std::cout << ssm[0][0][0] << std::endl;
//  checkSab( ssmCorrect, ssm );

    } // WHEN
  } // GIVEN

  */

    /*
  GIVEN( "H in ZrH" ) {


    nout   = 20;                                                 // Card 1
    title  = "H IN ZRH";                   // Card 2
    ntempr = 1;     iprint = 1;      nphon = 100;              // Card 3
    mat    = 7;     za     = 1007.0;                           // Card 4
    awr    = 0.99917; spr    = 20.478; npr   = 1;   iel = -1;   ncold = 0; // Card 5
    nss    = 0;       b7     = 0;     aws   = 0; sps = 0; mss = 0; 
                                                                     // Card 6
    nalpha = 48;       nbeta  = 200;      lat   = 1;                // Card 7
    alpha  = { 5.04060e-1, 1.00812e+0, 1.51218e+0, 2.01624e+0, 2.52030e+0, 
      3.02436e+0, 3.52842e+0, 4.03248e+0, 4.53654e+0, 5.04060e+0, 
      5.60867e+0, 6.24893e+0, 6.97044e+0, 7.78359e+0, 8.69997e+0, 
      9.73279e+0, 1.08968e+1, 1.22083e+1, 1.36872e+1, 1.53526e+1, 
      1.72308e+1, 1.93468e+1, 2.17320e+1, 2.44197e+1, 2.74491e+1, 
      3.08636e+1, 3.47106e+1, 3.90465e+1, 4.39338e+1, 4.94412e+1,
      5.56482e+1, 6.26425e+1, 7.05260e+1, 7.94105e+1, 8.94242e+1, 
      1.00708e+2, 1.13423e+2, 1.27759e+2, 1.43909e+2, 1.62116e+2, 
      170.0, 180.0, 190.0, 200.0, 210.0, 220.0, 230.0, 240.0 };     // Card 8
    beta   = { 0.00000e+0, 7.90678e-2, 1.58134e-1, 2.37200e-1, 3.16277e-1, 
      3.95344e-1, 4.74411e-1, 5.13939e-1, 5.53478e-1, 5.93016e-1, 6.32545e-1, 
      6.72083e-1, 7.11611e-1, 7.51150e-1, 7.90678e-1, 8.30217e-1, 8.69755e-1, 
      9.48822e-1, 1.02788e+0, 1.10691e+0, 1.18605e+0, 1.26509e+0, 1.34412e+0, 
      1.46278e+0, 1.58134e+0, 1.69999e+0, 1.81855e+0, 1.93720e+0, 2.05576e+0, 
      2.17441e+0, 2.29297e+0, 2.41162e+0, 2.53018e+0, 2.88594e+0, 3.20229e+0, 
      3.51854e+0, 3.87430e+0, 4.15103e+0, 4.46738e+0, 4.58594e+0, 4.66507e+0, 
      4.74411e+0, 4.82314e+0, 4.90218e+0, 4.98132e+0, 5.06035e+0, 5.13939e+0, 
      5.21853e+0, 5.29757e+0, 5.33708e+0, 5.37660e+0, 5.41612e+0, 5.45574e+0, 
      5.53478e+0, 5.61381e+0, 5.69295e+0, 5.77199e+0, 5.81150e+0, 5.85102e+0, 
      5.89054e+0, 5.93016e+0, 5.96968e+0, 6.00920e+0, 6.08823e+0, 6.16727e+0, 
      6.24641e+0, 6.32545e+0, 6.91842e+0, 7.51150e+0, 8.10447e+0, 9.09283e+0, 
      9.40908e+0, 9.72543e+0, 1.00417e+1, 1.03584e+1, 1.06740e+1, 1.07536e+1, 
      1.08322e+1, 1.09119e+1, 1.10691e+1, 1.12274e+1, 1.13857e+1, 1.15440e+1, 
      1.16226e+1, 1.17023e+1, 1.17809e+1, 1.18605e+1, 1.19392e+1, 1.20188e+1, 
      1.23343e+1, 1.26509e+1, 1.30461e+1, 1.36388e+1, 1.42326e+1, 1.48254e+1, 
      1.54182e+1, 1.57740e+1, 1.60110e+1, 1.62489e+1, 1.64858e+1, 1.67227e+1, 
      1.69606e+1, 1.71975e+1, 1.74344e+1, 1.76713e+1, 1.79092e+1, 1.81855e+1, 
      1.85020e+1, 1.89768e+1, 1.97672e+1, 2.05576e+1, 2.09527e+1, 2.13479e+1, 
      2.17441e+1, 2.21393e+1, 2.25345e+1, 2.29297e+1, 2.33248e+1, 2.37200e+1, 
      2.45114e+1, 2.53018e+1, 2.56970e+1, 2.60921e+1, 2.64883e+1, 2.68835e+1, 
      2.72787e+1, 2.76739e+1, 2.80691e+1, 2.84642e+1, 2.88594e+1, 2.92556e+1, 
      2.96508e+1, 3.02436e+1, 3.08363e+1, 3.12315e+1, 3.16277e+1, 3.20229e+1, 
      3.24181e+1, 3.28133e+1, 3.32085e+1, 3.36036e+1, 3.39988e+1, 3.43950e+1, 
      3.47902e+1, 3.55806e+1, 3.63709e+1, 3.71623e+1, 3.79527e+1, 3.87430e+1, 
      3.95344e+1, 40.25, 41.0, 41.75, 42.5, 43.25,  44.0, 44.75, 45.5, 46.25, 
      47.0, 47.75, 48.5, 49.25, 50.0, 51.75, 52.5, 53.25, 54.0, 54.75, 55.5, 
      56.25, 57.0, 57.75, 58.5, 59.25, 60.0, 60.75, 61.5, 62.25, 63.0, 63.75, 
      64.5, 65.25, 66.0, 66.75, 67.5, 68.25, 69.0, 69.75, 70.5, 71.25, 72.0, 
      72.75, 73.5, 74.25, 75.0, 75.75, 76.5, 77.25, 78.0 }; // Card 9
    temp   = { 296.0 };                                          // Card 10 
    delta  = 0.001;     ni     = 161;                           // Card 11
    rho    = { 0, 0.000875, 0.0035, 0.008, 0.015, 0.0235, 0.0340,
               0.046, 0.061, 0.078, 0.094, 0.116, 0.144, 0.1606, 0.1969, 
               0.2606, 0.3479, 0.3559, 0.3500, 0.3322, 0.3328, 0.2911, 
               0.1617, 0.1431, 0.1248, 0.09738, 0.06067, 0.1221, 0.1495, 
               0.07219, 0.01443, 0.0001, 0.82, 0.0499, 2.010, 3.560, 4.790, 
               5.995, 7.250, 8.550, 9.640, 11.91, 13.52, 16.04, 19.79, 26.10, 
               29.39, 30.82, 32.21, 31.75, 33.14, 35.65, 33.34, 36.27, 38.18, 
               38.75, 39.48, 28.99, 23.29, 25.18, 26.59, 27.86, 27.89, 29.44, 
               25.86, 23.33, 24.66, 27.51, 37.94, 60.77, 26.66, 18.54, 14.51, 
               11.48, 9.53, 7.53, 5.449, 3.838, 8.497, 0 }; // Card 12
    twt    = 0.0;     c      = 0.0;    tbeta = 1.0;    // Card 13
    nd     = 0;                                                  // Card 14
    //oscE  = { 205.0,    0.48};                                  // Card 15
    oscE   = { };                                  // Card 15
    oscW   = { };                             // Card 16
    nka    = 0;       dka    = 0.0;                             // Card 17
    kappa  = { };                             // Card 18

 
    auto ssm = leapr( nout, title, ntempr, iprint, nphon, mat, za, awr, 
        spr, npr, iel, ncold, nss, aws, nalpha, nbeta, lat, alpha, beta, 
        temp, delta, ni, rho, twt, c, tbeta, nd, oscE, 
        oscW, nka, dka, kappa );
    std::vector<double> ssmCorrect { };


   // std::cout << ssm[0][0][0] << std::endl;
   // std::cout << ssm[1][1][0] << std::endl;
   // std::cout << ssm[2][2][0] << std::endl;
   // std::cout << ssm[3][3][0] << std::endl;

    //checkSab( ssmCorrect, ssm );

  } // GIVEN 
  */
} // TEST CASE
